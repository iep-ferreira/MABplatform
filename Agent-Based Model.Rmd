---
title: "Prototype - An agent-based platform to evaluate the performance of sampling designs and modelling approaches when estimating animal abundance"
author: "Iuri Ferreira, Equipe CeMECA"
date: "08/12/2023"
output: 
  html_document: 
#    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Pacotes / Dependências

```{r}
#install.packages("landscapeR")
#install.packages("raster")
library(raster) 
library(landscapeR)
```

## Carrega as funções através do código-fonte

```{r}
source("./source-codes/functions.R")
```

## Função que cria o ambiente aleatório (paisagem)

O usuário pode configurar o tamanho da rede ``l.size``, o *vetor* número de fragmentos ``n.patches``, com três níveis de recurso (pobre, intermediário, rico), e cobertura de cada tipo de fragmento ``cover`` (soma da ``cover`` < 1).   

 + ``default`` para ``l.size`` é 100 px,
 + ``default`` para ``n.patches`` é 2 fragmentos de cada tipo,
 + ``default`` para ``cover`` é de 25% para cada tipo de fragmento.   

```{r}
# Criando a Paisagem
land <- land.create(l.size = 500, n.patches =  c(1, 2, 3), cover = c(0.20,0.15,0.30))
plot(land$raster)
```

## Carregamento de um mapa real de uso e ocupação do solo no Brasil

Usando o programa bioma stats. 

```{r}
library(biomastats)
library(sf)
library(mapview)
```

  - Delimitação da área
  
```{r}
make_polygon(lat = -23.6, lon = -48.5, size = 1, shape = "square")
(path_package <- system.file(package = "biomastats"))
```

```{r}
shp_path <- file.path(path_package, "shp/polygon.shp")
mapview(sf::read_sf(shp_path))
```

  - Download dos mapas de uso e ocupação para algum ano de interesse

```{r}
data_maps <- load_rasters(shape_path = shp_path, start=1985, end=2020, data_from = "example")
```

  Obs: Urgente: coorigir no bioma stats > função land_vis Error in data$raster[[year - 1984]] : subscript out of bounds

```{r}
land_vis(data_maps, year = 2020)
```


```{r}
land <- data_maps$raster[[35]]
plot(land)
```

```{r}
unique(getValues(land))
```


## Movimentação dos animais 

  + As simulações representam ``21`` semanas consecutivas, em que cada passo de tempo dura uma hora. 

  + O movimento é uma adaptação do caminho aleatório, mas considerando tempos de permanência proporcionais à qualidade do recurso. 

  + As ``20`` semanas inciais são para a **fase de adaptação**. Assim os indivíduos podem estabelecer o padrão natural de ocupação a partir de posições iniciais.   

  + A simulação da deposição de vestígios e coleta dos dados ocorre nas duas semanas finais. 

  + Nas simulações, a taxa individual de produção de vestígios foi fixada em ``quatro`` vestígios por dia.    

    + ``n`` o tamanho populacional 
    + ``ra`` é o argumento que recebe o ``raster`` da paisagem
    + ``time`` é o número de semanas (adaptação + coleta de dados)
    + ``where`` é onde posicionamos os animais no início da população. (``all`` para posicioná-los em todo o ambiente e ``resources`` para apenas aonde tem recursos).
 
```{r}
# ra <- land$raster
ra <- land
mov <- animal.mov(n = dim(ra)[1], ra = ra , time = 21, where = "resource")
```


## Para visualizar a movimentação animal 
   
   + Com ``adapt = FALSE`` visualizamos apenas as duas semanas finais; 
   
   + Com ``adapt = TRUE`` visualizamos todas as semanas, incluindo a fase de adaptação. 

```{r}
dim(land)
raster_obj <- raster(as.matrix(land), xmn=0, xmx=dim(land)[1]-1, ymn=0, ymx=dim(land)[1]-1)
# tem alguma coisa de errado na função de movimentação! 
tracks.viewer(obj = mov, r = raster_obj, adapt = FALSE)
tracks.viewer(obj = mov, r = raster_obj, adapt = TRUE)
```

## Para visualizar os vestígios

 + Para visualizar os vestígios depositados no ambiente. 

```{r}
traces.viewer(obj = mov,r = ra)
```

## Para fixar os transectos

 + Os transectos podem ser linhas retas ou caminhos aleatórios (há um parâmetro de convolução);
 
 + Eles podem ser fixados em toda a área, aleatoriamente, ou apenas aonde tem recurso: 
 
    + ``sampling == random`` significa amostragem aleatória;
 
    + ``sampling == random`` é amostragem por conveniência. 

```{r}
tracks<-tracks.set(obj = mov, ra = ra, sampling = "random",
                   l = 1000, con = 0)
tracks$coverage
tracks$counts
```


